<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Operator Dashboard</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- External Libraries -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Dark Theme Helpers -->
    <script src="{{ url_for('static', filename='js/chart-dark-theme.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/leaflet-dark-theme.js') }}" defer></script>
</head>

<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1>ðŸ”´ Live Operator Dashboard</h1>
                <span class="module-badge">Real-Time Only - Post-Login Events</span>
            </div>
            <div class="header-right">
                <span class="login-info">Logged in: {{ login_time[:19] if login_time else 'Unknown' }}</span>
                <a href="/live/logout" class="logout-btn">Logout</a>
            </div>
        </div>
        <div class="warning-bar">
            {{ security_warning }}
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="dashboard-main">
        <!-- Status Bar -->
        <section class="status-bar">
            <div class="status-item">
                <span class="status-label">Real-time:</span>
                <span id="status-realtime">Connecting...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Total Events:</span>
                <span id="status-total">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Countries:</span>
                <span id="status-countries">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Last Attack:</span>
                <span id="status-last">Loading...</span>
            </div>
        </section>

        <!-- Controls -->
        <section class="controls-section">
            <div class="filters">
                <input type="text" id="filter-ip" placeholder="Filter by IP..." />
                <select id="filter-country">
                    <option value="">All Countries</option>
                </select>
                <select id="filter-type">
                    <option value="">All Attack Types</option>
                    <option value="login_attempt">Login Attempt</option>
                    <option value="sql_injection">SQL Injection</option>
                    <option value="xss">XSS</option>
                </select>
                <input type="datetime-local" id="filter-since" placeholder="From date/time..."
                    title="Leave empty to show only events after login" />
                <button id="btn-apply-filters">Apply Filters</button>
                <button id="btn-clear-filters">Clear</button>
                <button id="btn-export-csv">Export CSV</button>
            </div>
            <div class="view-controls">
                <label>
                    <input type="checkbox" id="auto-scroll" checked /> Auto-scroll events
                </label>
                <label>
                    Time Range:
                    <select id="time-range">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last Week</option>
                    </select>
                </label>
            </div>
        </section>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Live Events Feed -->
            <section class="panel events-panel">
                <h2>Live Events Feed</h2>
                <div class="filter-info"
                    style="padding: 0.5rem 1rem; background: #e3f2fd; border-left: 4px solid #2196F3; margin-bottom: 1rem; border-radius: 4px;">
                    <small>ðŸ“Œ <strong>Note:</strong> Showing only attacks that occurred after your login time. Use
                        filters above to view historical data.</small>
                </div>
                <div class="events-container">
                    <div id="events-feed" class="events-feed">
                        <!-- Events will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Charts Panel -->
            <section class="panel charts-panel">
                <h2>Analytics</h2>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Events Timeline</h3>
                        <canvas id="timeline-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Top Countries</h3>
                        <canvas id="countries-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Top IPs</h3>
                        <canvas id="ips-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Attack Types</h3>
                        <canvas id="types-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Map Panel -->
            <section class="panel map-panel">
                <h2>Attack Origins</h2>
                <div id="attack-map" class="attack-map"></div>
            </section>
        </div>
    </main>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Event Details</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="event-detail-content">
                    <!-- Event details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/live_dashboard.js') }}"></script>
</body>

</html>